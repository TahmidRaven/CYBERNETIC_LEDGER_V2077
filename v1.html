<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBERNETIC LEDGER // 2077</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cyberpunk Color Palette
                        'bg-dark': '#0a0a0d', // Near Black background
                        'primary-dark': '#15151a', // Dark container/form background
                        'neon-blue': '#00ffff', // Electric Cyan (Primary Accent)
                        'neon-pink': '#ff00ff',  // Magenta (Secondary Accent/Hover)
                        'neon-green': '#00ff7f', // Success
                        'neon-red': '#ff4500',   // Danger (Orange/Red)
                        'text-light': '#f3f4f6', // Light gray primary text
                        'text-muted': '#9ca3af', // Gray secondary text
                    },
                    boxShadow: {
                        // Neon glow effects for tiles and header
                        'neon-glow-blue': '0 0 5px #00ffff80, 0 0 10px #00ffff40',
                        'neon-glow-pink': '0 0 5px #ff00ff80, 0 0 10px #ff00ff40',
                        'lift': '0 4px 8px -2px rgba(0, 255, 255, 0.1), 0 2px 4px -2px rgba(0, 255, 255, 0.05)',
                        'lift-hover': '0 8px 15px -4px rgba(0, 255, 255, 0.3), 0 4px 8px -2px rgba(0, 255, 255, 0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Only keeping Inter for general UI elements if needed, but primary is Canada Gothic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            /* Changed to Canada Gothic with monospace fallback */
            font-family: 'Canada Gothic', monospace; 
            background-color: #0a0a0d; /* BG Dark */
            color: #f3f4f6; /* Default text light */
        }
        h1, h2 {
            /* Changed to Canada Gothic for headings */
            font-family: 'Canada Gothic', monospace;
            text-shadow: 0 0 5px var(--neon-blue);
        }
        /* Applying dark theme and neon text to inputs */
        input, select, textarea {
            background-color: #1f2937 !important; 
            color: #00ffff !important; 
            border: 1px solid #00ffff30 !important;
            transition: all 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #00ffff !important;
            box-shadow: 0 0 8px #00ffff !important;
        }

        /* Generic classes for components */
        .balance-card, .transaction-card {
            transition: all 0.3s ease-in-out;
            border: 1px solid #00ffff20; /* Subtle cyan border */
        }
        .btn-hover {
            transition: all 0.3s ease;
        }
        .btn-hover:hover {
            box-shadow: 0 0 15px #ff00ff; /* Pink hover glow */
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen bg-bg-dark text-text-light">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center py-6 mb-10 bg-primary-dark rounded-xl shadow-neon-glow-blue border border-neon-blue/40">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-neon-blue">CYBERNETIC LEDGER // V 2077</h1>
            <div class="flex flex-col sm:flex-row justify-center items-center mt-3 space-y-2 sm:space-y-0 sm:space-x-4 text-text-muted">
                <p id="userIdDisplay" class="text-sm">IDENTITY: Loading...</p>
                <div class="flex items-center space-x-2">
                    <label for="currencySelect" class="text-sm font-medium text-neon-blue">DISPLAY UNIT:</label>
                    <select id="currencySelect" class="rounded-lg shadow-sm text-sm p-1">
                        <option value="৳">BDT (৳)</option>
                        <option value="$">USD ($)</option>
                        <option value="€">EURO (€)</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center p-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-neon-blue mx-auto"></div>
            <p class="mt-4 text-neon-blue">SYNCHRONIZING DATA...</p>
        </div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="mainContent" class="hidden">
            
            <!-- Account Balances Section -->
            <section class="mb-10">
                <h2 class="text-xl font-bold text-neon-blue mb-4 border-b border-neon-blue/50 pb-2">ACTIVE BALANCE PROFILES</h2>
                <div id="balancesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Balances will be inserted here by JavaScript -->
                </div>
            </section>

            <!-- INITIAL BALANCE/ADJUSTMENT Section -->
            <section class="mb-10 bg-primary-dark p-6 rounded-xl shadow-lift border border-neon-blue/20">
                <h2 class="text-xl font-bold text-neon-blue mb-4 border-b border-neon-blue/50 pb-2">1. INJECT/ADJUST FUNDS (MANUAL OVERRIDE)</h2>
                <form id="adjustmentForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="adj_account" class="block text-sm font-medium text-text-light">PROFILE NAME</label>
                            <input type="text" id="adj_account" required class="mt-1 block w-full rounded-lg shadow-md p-2.5 border" placeholder="e.g., Nazmul Bank BDT">
                        </div>
                        <div class="md:col-span-2">
                            <label for="adj_balance" class="block text-sm font-medium text-text-light">SET BALANCE TO (NET VALUE)</label>
                            <input type="number" id="adj_balance" required step="0.01" class="mt-1 block w-full rounded-lg shadow-md p-2.5 border" placeholder="e.g., 6000 or -500">
                        </div>
                    </div>
                    <button type="submit" class="btn-hover w-full py-2.5 px-4 rounded-lg shadow-neon-glow-pink text-sm font-bold text-bg-dark bg-neon-pink hover:bg-neon-pink/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-neon-pink transition duration-150 ease-in-out">
                        EXECUTE BALANCE INJECTION
                    </button>
                    <p id="adjFormMessage" class="mt-2 text-center text-sm hidden"></p>
                </form>
            </section>

            <!-- New TRANSACTION Section (UPDATED FOR DYNAMIC RECIPIENTS) -->
            <section class="mb-10 bg-primary-dark p-6 rounded-xl shadow-lift border border-neon-blue/20">
                <h2 class="text-xl font-bold text-neon-blue mb-4 border-b border-neon-blue/50 pb-2">2. RECORD TRANSFER (PEER-TO-PEER MOVEMENT)</h2>
                <form id="transactionForm" class="space-y-6">
                    <!-- Payer & Total Section -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b border-neon-blue/20 pb-4">
                        <div>
                            <label for="payer" class="block text-sm font-medium text-text-light">SOURCE PROFILE (PAYER)</label>
                            <input type="text" id="payer" required class="mt-1 block w-full rounded-lg shadow-md p-2.5 border" placeholder="e.g., Nazmul">
                        </div>
                        <div class="md:col-span-2">
                            <label for="totalAmount" class="block text-sm font-medium text-text-light">TOTAL PAID AMOUNT</label>
                            <input type="number" id="totalAmount" required min="0.01" step="0.01" class="mt-1 block w-full rounded-lg shadow-md p-2.5 border font-bold text-lg" placeholder="e.g., 100">
                        </div>
                    </div>
                    
                    <!-- Recipients Section -->
                    <h3 class="text-lg font-semibold text-neon-blue">TARGET PROFILES (RECIPIENTS)</h3>
                    <div id="recipientsContainer" class="space-y-3 p-3 bg-primary-dark/50 rounded-lg border border-dashed border-neon-blue/50">
                        <!-- Dynamic Recipient Inputs Go Here -->
                    </div>

                    <button type="button" id="addRecipientBtn" class="py-1.5 px-4 border border-dashed border-neon-blue text-neon-blue rounded-lg text-sm hover:bg-primary-dark transition duration-150 ease-in-out">
                        + ADD TARGET
                    </button>

                    <!-- Notes & Submit -->
                    <div class="mt-4 pt-4 border-t border-neon-blue/20">
                        <label for="notes" class="block text-sm font-medium text-text-light">OPERATOR NOTES (CONTEXT)</label>
                        <input type="text" id="notes" class="mt-1 block w-full rounded-lg shadow-md p-2.5 border" placeholder="e.g., 3$ + 100 for groceries">
                    </div>

                    <button type="submit" class="btn-hover w-full py-2.5 px-4 rounded-lg shadow-neon-glow-blue text-sm font-bold text-bg-dark bg-neon-blue hover:bg-neon-blue/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-neon-blue transition duration-150 ease-in-out">
                        INITIATE TRANSFER
                    </button>
                    <p id="jsonError" class="mt-2 text-center text-sm text-neon-red hidden"></p>
                    <p id="formMessage" class="mt-2 text-center text-sm hidden"></p>
                </form>
            </section>

            <!-- Transaction History Section -->
            <section>
                <h2 class="text-xl font-bold text-neon-blue mb-4 border-b border-neon-blue/50 pb-2 flex justify-between items-center">
                    TRANSACTION HISTORY LOG
                    <div class="flex items-center space-x-2 bg-primary-dark/80 p-1 rounded-lg border border-neon-blue/30 shadow-neon-glow-blue/50">
                        <input type="checkbox" id="hideAdjustments" class="h-4 w-4 text-neon-blue bg-primary-dark border-neon-blue rounded focus:ring-neon-blue">
                        <label for="hideAdjustments" class="text-sm text-text-light select-none">FILTER ADJUSTMENTS</label>
                    </div>
                </h2>
                <div id="transactionsList" class="space-y-4">
                    <!-- Transactions will be inserted here by JavaScript -->
                    <p id="noTransactions" class="text-text-muted text-center p-4 bg-primary-dark/80 rounded-xl shadow-lift border border-neon-blue/10 hidden">NO DATA ENCRYPTED IN LOG.</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Firebase SDKs and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection, 
            query, 
            orderBy, 
            serverTimestamp,
            increment,
            runTransaction,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- CURRENCY SETTINGS ---
        let currentCurrencySymbol = '৳'; // Default to BDT

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let transactionsData = []; 

        // UI Elements
        const mainContent = document.getElementById('mainContent');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const balancesGrid = document.getElementById('balancesGrid');
        const transactionsList = document.getElementById('transactionsList');
        const transactionForm = document.getElementById('transactionForm');
        const formMessage = document.getElementById('formMessage');
        const adjForm = document.getElementById('adjustmentForm');
        const adjFormMessage = document.getElementById('adjFormMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const noTransactions = document.getElementById('noTransactions');
        const hideAdjustmentsCheckbox = document.getElementById('hideAdjustments');
        const jsonError = document.getElementById('jsonError');
        const recipientsContainer = document.getElementById('recipientsContainer');
        const addRecipientBtn = document.getElementById('addRecipientBtn');
        const currencySelect = document.getElementById('currencySelect');


        /**
         * Initializes Firebase and handles authentication.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                loadingIndicator.innerHTML = '<p class="text-neon-red">ERROR: FIRBASE LINK MISSING.</p>';
                return;
            }

            try {
                // setLogLevel('debug'); // Uncomment for detailed debug logs
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set initial currency and listener
                currentCurrencySymbol = currencySelect.value;
                currencySelect.addEventListener('change', (e) => {
                    currentCurrencySymbol = e.target.value;
                    // Rerender both balances and transactions to apply the new symbol
                    renderBalances();
                    renderTransactions();
                });

                // 1. Authentication Check
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `IDENTITY: ${userId}`;
                        isAuthReady = true;
                        
                        // 2. Start real-time listeners only after successful sign-in
                        setupListeners();

                        // 3. Show main content
                        loadingIndicator.classList.add('hidden');
                        mainContent.classList.remove('hidden');

                    } else {
                        // Attempt sign in
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                loadingIndicator.innerHTML = `<p class="text-neon-red">ERROR: CONNECTION FAIL. ${error.message}</p>`;
            }
        }

        /**
         * Returns the path for public data collections.
         * @param {string} collectionName 
         * @returns {string}
         */
        function getPublicCollectionPath(collectionName) {
            return `artifacts/${appId}/public/data/${collectionName}`;
        }
        
        /**
         * Renders the current account balances from the last snapshot.
         */
        let accountSnapshotCache = [];
        function renderBalances() {
            balancesGrid.innerHTML = '';

            if (accountSnapshotCache.length === 0) {
                balancesGrid.innerHTML = '<p class="col-span-4 text-text-muted p-4 bg-primary-dark rounded-xl shadow-lift">NO ACTIVE PROFILES FOUND. CREATE ONE VIA INJECTION.</p>';
                return;
            }

            accountSnapshotCache.forEach(doc => {
                const data = doc.data();
                const accountName = doc.id;
                const balance = data.balance || 0;
                
                const isPositive = balance >= 0;
                // Cyberpunk colors for status
                const balanceClass = isPositive ? 'text-neon-green' : 'text-neon-red';
                const bgColorClass = isPositive ? 'bg-neon-green/10' : 'bg-neon-red/10'; 
                const icon = isPositive ? '&#x25B2;' : '&#x25BC;'; 
                
                // Use the globally selected currency symbol
                const formattedBalance = `${currentCurrencySymbol} ${Math.abs(balance).toFixed(2)}`;

                const cardHtml = `
                    <div class="balance-card bg-primary-dark p-5 rounded-xl shadow-lift border-l-4 ${isPositive ? 'border-neon-green' : 'border-neon-red'} hover:shadow-lift-hover transition duration-200 cursor-pointer">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-text-light truncate">${accountName}</h3>
                            <span class="text-xs font-bold px-2 py-0.5 rounded-full ${bgColorClass} ${balanceClass}">
                                ${isPositive ? 'ASSET' : 'LIABILITY'}
                            </span>
                        </div>
                        <p class="text-3xl font-extrabold ${balanceClass} mt-2">
                            ${icon} ${formattedBalance}
                        </p>
                    </div>
                `;
                balancesGrid.innerHTML += cardHtml;
            });
        }
        
        /**
         * Renders the transaction list based on cached data and filter state.
         */
        function renderTransactions() {
            transactionsList.innerHTML = '';
            const hideAdj = hideAdjustmentsCheckbox.checked;

            const filteredData = hideAdj 
                ? transactionsData.filter(t => t.type !== 'ADJUSTMENT') 
                : transactionsData;

            if (filteredData.length === 0) {
                noTransactions.classList.remove('hidden');
                return;
            }
            noTransactions.classList.add('hidden');

            filteredData.forEach(data => {
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
                
                const participantEntries = Object.entries(data.participants || {});
                
                let descriptionDetail = '';
                const formattedAmount = `${currentCurrencySymbol} ${data.amount.toFixed(2)}`;
                let mainAmountDisplay = formattedAmount;
                const isAdjustment = data.type === 'ADJUSTMENT';

                if (isAdjustment) {
                    descriptionDetail = `<span class="italic text-text-muted">Balance manually set to ${formattedAmount}</span>`;
                    mainAmountDisplay = 'ADJUSTMENT'; 
                } else {
                    descriptionDetail = participantEntries.map(([name, change]) => 
                        `<span class="${change > 0 ? 'text-neon-green' : 'text-neon-red'} font-semibold">${name} (${change > 0 ? '+' : ''}${currentCurrencySymbol}${Math.abs(change).toFixed(2)})</span>`
                    ).join(' // ');
                }
                
                const cardClass = isAdjustment 
                    ? 'border-neon-blue/10 bg-primary-dark/50 shadow-inner' // Different style for adjustment
                    : 'border-neon-blue/50 bg-primary-dark shadow-lift hover:shadow-lift-hover'; // Glossy lift for transfers

                const transactionHtml = `
                    <div class="transaction-card p-4 rounded-xl border-l-4 ${cardClass} transition duration-200 text-sm">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-bold text-neon-blue">${data.description}</p>
                            <span class="text-lg font-extrabold text-neon-pink">${mainAmountDisplay}</span>
                        </div>
                        <p class="text-xs text-text-light mb-2">
                            <span class="font-bold text-neon-blue/80">NET IMPACT:</span> ${descriptionDetail}
                        </p>
                        ${data.notes ? `<p class="text-xs text-text-muted italic">LOG: ${data.notes}</p>` : ''}
                        <p class="text-xs text-text-muted mt-2 text-right">TIMESTAMP: ${date}</p>
                    </div>
                `;
                transactionsList.innerHTML += transactionHtml;
            });
        }


        /**
         * Sets up real-time listeners for balances and transactions.
         */
        function setupListeners() {
            if (!isAuthReady) return;

            // --- 1. Listen for Account Balances ---
            const accountsRef = collection(db, getPublicCollectionPath('accounts'));
            onSnapshot(accountsRef, (snapshot) => {
                accountSnapshotCache = snapshot.docs;
                renderBalances();
            }, (error) => {
                console.error("Error listening to accounts:", error);
            });


            // --- 2. Listen for Transaction History ---
            const transactionsRef = collection(db, getPublicCollectionPath('transactions'));
            const q = query(transactionsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                // Cache data and trigger render
                transactionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTransactions();
            }, (error) => {
                console.error("Error listening to transactions:", error);
            });

            // Add event listener for filtering
            hideAdjustmentsCheckbox.addEventListener('change', renderTransactions);

            // Initialize with one recipient row
            addRecipientInput(); 
            addRecipientBtn.addEventListener('click', addRecipientInput);
        }
        
        // --- Dynamic Input Functions ---
        
        /**
         * Creates and inserts a new dynamic input row for a recipient.
         */
        function addRecipientInput() {
            const container = document.createElement('div');
            container.className = 'grid grid-cols-12 gap-2 recipient-row items-center';

            container.innerHTML = `
                <div class="col-span-6">
                    <input type="text" placeholder="TARGET PROFILE (e.g., Dokan uncle)" class="recipient-name mt-1 block w-full rounded-lg shadow-sm p-2.5 border text-sm" required>
                </div>
                <div class="col-span-4">
                    <input type="number" step="0.01" min="0.01" placeholder="AMOUNT" class="recipient-amount mt-1 block w-full rounded-lg shadow-sm p-2.5 border text-sm" required>
                </div>
                <div class="col-span-2 flex items-center justify-end">
                    <button type="button" class="remove-recipient text-neon-red hover:text-neon-pink font-bold text-xs transition duration-150 ease-in-out px-2 py-1 rounded-md hover:bg-neon-red/10">
                        // DELETE
                    </button>
                </div>
            `;
            
            // Event listener for removal
            container.querySelector('.remove-recipient').addEventListener('click', () => {
                // Prevent removing the last row
                if (recipientsContainer.querySelectorAll('.recipient-row').length > 1) {
                    recipientsContainer.removeChild(container);
                } else {
                    showMessage("MINIMUM ONE TARGET REQUIRED.", 'red', jsonError);
                }
            });

            recipientsContainer.appendChild(container);
            jsonError.classList.add('hidden'); // Clear error on new input
        }

        /**
         * Gathers and validates all participant data from dynamic inputs.
         * @param {number} totalAmount - The total amount paid by the payer.
         * @returns {{participants: Object, totalRecipientAmount: number} | null} - Null on validation failure.
         */
        function getTransactionParticipants(totalAmount) {
            const recipientRows = recipientsContainer.querySelectorAll('.recipient-row');
            const participants = {};
            let totalRecipientAmount = 0;
            jsonError.classList.add('hidden');

            if (recipientRows.length === 0) {
                showMessage("MISSING TARGETS. ADD AT LEAST ONE.", 'red', jsonError);
                return null;
            }

            for (const row of recipientRows) {
                const nameInput = row.querySelector('.recipient-name');
                const amountInput = row.querySelector('.recipient-amount');

                const name = nameInput.value.trim();
                const amount = parseFloat(amountInput.value);

                if (!name) {
                    showMessage("TARGET PROFILE NAME EMPTY.", 'red', jsonError);
                    return null;
                }
                if (isNaN(amount) || amount <= 0) {
                    showMessage(`INVALID AMOUNT FOR PROFILE: ${name}. MUST BE POSITIVE.`, 'red', jsonError);
                    return null;
                }
                
                // Capitalize for consistent Firestore keys
                const RecipientID = name.charAt(0).toUpperCase() + name.slice(1);
                
                // Check for duplicate names
                if (participants[RecipientID]) {
                    showMessage(`DUPLICATE TARGET PROFILE DETECTED: ${RecipientID}.`, 'red', jsonError);
                    return null;
                }

                participants[RecipientID] = amount;
                totalRecipientAmount += amount;
            }

            // Final Validation: Check if the sum of recipients matches the total amount
            // Allow for a very small tolerance due to floating point arithmetic
            if (Math.abs(totalRecipientAmount - totalAmount) > 0.01) { 
                jsonError.textContent = `TARGET SUM (${totalRecipientAmount.toFixed(2)}) MISMATCHES TOTAL PAID (${totalAmount.toFixed(2)}). VALIDATION FAILED.`;
                jsonError.style.display = 'block';
                showMessage("VALIDATION FAILED: AMOUNT MISMATCH.", 'red', formMessage);
                return null;
            }

            return { participants, totalRecipientAmount };
        }
        
        // --- Form Functions ---

        /**
         * Handles the form submission for initial balance/adjustment.
         */
        adjForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showMessage("CONNECTION NOT READY. RETRY.", 'red', adjFormMessage);
                return;
            }

            const accountName = document.getElementById('adj_account').value.trim();
            const newBalance = parseFloat(document.getElementById('adj_balance').value);

            if (!accountName || isNaN(newBalance)) {
                showMessage("INVALID PROFILE NAME OR BALANCE.", 'red', adjFormMessage);
                return;
            }

            const AccountID = accountName.charAt(0).toUpperCase() + accountName.slice(1);

            showMessage("EXECUTING INJECTION...", 'blue', adjFormMessage);

            try {
                const accountRef = doc(db, getPublicCollectionPath('accounts'), AccountID);
                await setDoc(accountRef, { 
                    balance: newBalance, 
                    lastUpdated: serverTimestamp() 
                }, { merge: true });

                // Record the adjustment as a special transaction for history
                const transactionsRef = doc(collection(db, getPublicCollectionPath('transactions')));
                await setDoc(transactionsRef, {
                    timestamp: serverTimestamp(),
                    description: `MANUAL BALANCE ADJUSTMENT FOR ${AccountID}`,
                    amount: newBalance,
                    participants: { [AccountID]: newBalance }, 
                    notes: `BALANCE MANUALLY SET TO ${newBalance}`,
                    recordedBy: userId,
                    type: 'ADJUSTMENT' 
                });

                showMessage(`INJECTION SUCCESSFUL FOR ${AccountID}: ${newBalance.toFixed(2)}!`, 'green', adjFormMessage);
                adjForm.reset(); 
            } catch (e) {
                console.error("Adjustment failed: ", e);
                showMessage(`ADJUSTMENT FAILED: ${e.message}`, 'red', adjFormMessage);
            }
        });


        /**
         * Handles the form submission to record a new transaction (transfer, multi-party capable).
         * @param {Event} e 
         */
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showMessage("CONNECTION NOT READY. RETRY.", 'red', formMessage);
                return;
            }

            const payer = document.getElementById('payer').value.trim();
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const notes = document.getElementById('notes').value.trim();

            if (!payer || isNaN(totalAmount) || totalAmount <= 0) {
                showMessage("MISSING SOURCE PROFILE OR INVALID AMOUNT.", 'red', formMessage);
                return;
            }
            
            // 1. Get and validate recipient data from dynamic inputs
            const recipientData = getTransactionParticipants(totalAmount);
            if (!recipientData) return; // Validation failed, message already shown

            const { participants: recipientsMap } = recipientData;
            
            // Prepare final data structure
            const PayerID = payer.charAt(0).toUpperCase() + payer.slice(1);
            
            // 2. Add the Payer to the participants map (negative change)
            const finalParticipants = { ...recipientsMap };
            finalParticipants[PayerID] = (finalParticipants[PayerID] || 0) - totalAmount;

            showMessage("INITIATING TRANSFER...", 'blue', formMessage);

            try {
                await runTransaction(db, async (t) => {
                    
                    // 3. Update all involved Accounts
                    for (const name in finalParticipants) {
                        const change = finalParticipants[name];
                        const accountRef = doc(db, getPublicCollectionPath('accounts'), name);
                        t.set(accountRef, { 
                            balance: increment(change), 
                            lastUpdated: serverTimestamp() 
                        }, { merge: true });
                    }

                    // 4. Record the Transaction History
                    const transactionsRef = doc(collection(db, getPublicCollectionPath('transactions')));
                    
                    // Create a description listing the recipients
                    const recipientNames = Object.keys(recipientsMap).join(', ');
                    const description = `${PayerID} PAID ${totalAmount.toFixed(2)} TO ${recipientNames}`;

                    t.set(transactionsRef, {
                        timestamp: serverTimestamp(),
                        description: description,
                        amount: totalAmount,
                        participants: finalParticipants,
                        notes: notes,
                        recordedBy: userId,
                        type: 'TRANSFER'
                    });
                });

                showMessage("TRANSFER COMPLETE. LOG UPDATED.", 'green', formMessage);
                transactionForm.reset(); 
                // Clear and reset recipient inputs
                recipientsContainer.innerHTML = '';
                addRecipientInput(); 

            } catch (e) {
                console.error("Transaction failed: ", e);
                showMessage(`TRANSFER FAILED: ${e.message}`, 'red', formMessage);
            }
        });

        /**
         * Displays a temporary message in the form area.
         * @param {string} message 
         * @param {'green'|'red'|'blue'} color 
         * @param {HTMLElement} element - The message element to update
         */
        function showMessage(message, color, element) {
            let tailwindColor = color === 'green' ? 'text-neon-green' : (color === 'red' ? 'text-neon-red' : 'text-neon-blue');

            element.textContent = message;
            element.classList.remove('hidden', 'text-neon-green', 'text-neon-red', 'text-neon-blue');
            element.classList.add(tailwindColor);
            
            setTimeout(() => {
                element.classList.add('hidden');
                element.classList.remove(tailwindColor);
            }, 5000);
        }

        // Start the application initialization
        initializeFirebase();

    </script>

</body>
</html>